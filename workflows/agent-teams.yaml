# Agent Teams Mode (T) Workflow
# 調査・レビュー・設計探索専用ワークフロー
#
# 前提条件:
#   CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 が設定されていること
#
# 特徴:
#   - Conductorが自然言語でAgent Teamsを直接操作
#   - Dispatch不要、queue不要、send-keys不要
#   - 調査・レビュー・設計探索に特化（コード実装はパターンA/B/C）
#
# 適用ユースケース:
#   1. 並列コードレビュー（複数観点）
#   2. 競合仮説によるデバッグ調査
#   3. 技術調査・リサーチ
#   4. 新モジュール/機能の設計検討
#   5. クロスレイヤー変更の計画

name: agent-teams-mode
description: "Agent Teamsモード - 調査・レビュー専用（実験的）"
cost_level: medium
mode: T  # パターンではなくモード

# フェーズ定義
phases:
  # Phase 1: 計画・判定
  plan:
    agent: conductor
    model: opus
    actions:
      - analyze_task
      - determine_mode:  # モードT判定
          conditions:
            - task_type: research_or_review  # 調査・レビュー系
            - requires_multiple_perspectives: true  # 複数観点必要
            - worker_communication: required  # ワーカー間通信必要
      - user_approval

  # Phase 2: チーム作成
  team_setup:
    method: natural_language
    actor: conductor  # Conductorが直接操作
    actions:
      - team_creation:
          # 自然言語で指示
          instruction_template: >
            Create an agent team to {task_description}.
            Spawn {teammate_count} teammates with the following roles: {roles}.
            Use Sonnet model for all teammates.
      - enable_delegate_mode:
          # Shift+Tab で有効化
          method: keyboard_shortcut
          effect: restrict_conductor_to_coordination
      - assign_tasks:
          # 各teammateに自然言語で指示
          method: natural_language
          encourage_discussion: true  # メイト間議論を推奨

  # Phase 3: 実行監視
  execution:
    method: agent_teams_direct
    actor: conductor  # Conductorが監視
    actions:
      - monitor_progress:
          # 共有タスクリストを監視
          source: shared_task_list  # ~/.claude/tasks/{team-name}/
          poll_interval: 60  # 1分ごと
          timeout: 1800  # 30分
      - check_in:
          # 定期的にチェックイン
          frequency: 5_minutes
          redirect_if_stuck: true

  # Phase 4: 結果統合
  synthesis:
    actor: conductor
    actions:
      - collect_results:
          # 各メイトの結果を収集
          method: natural_language  # "Summarize your findings"
      - resolve_conflicts:
          # 矛盾があれば調整
          method: re_investigation  # 再調査を指示
      - create_report:
          # 最終レポート作成
          format: markdown
          include:
            - summary
            - each_perspective
            - recommendations

  # Phase 5: 報告
  report:
    actor: conductor
    actions:
      - present_to_user:
          # ユーザーに報告
          format: structured_report
      - team_cleanup:
          # チームをクリーンアップ
          method: natural_language
          instruction: "Clean up the team"

# フォールバック設定
fallback:
  on_error: sequential_investigation  # Agent Teams障害時は順次実行
  conditions:
    - agent_teams_unavailable
    - team_create_failed
    - timeout_exceeded
  cleanup_on_fallback:
    - team_shutdown  # "Clean up the team" を実行
    - record_failure  # MEMORY.md更新用に記録

# モードT設定
mode_t_config:
  teammate_mode: tmux  # Ensembleはtmux推奨
  shared_task_list_path: ~/.claude/tasks/{team_name}/
  delegate_mode: enabled  # Conductor = 調整専用
  max_duration: 1800  # 30分
